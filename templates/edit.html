{% extends "base.html" %}

{% block content %}
<div class="page-header v-h">
    <h1>Edit Order</h1>
    <a href="{{ url_for('order_list') }}" class="btn btn-secondary">Back</a>
</div>

<div class="form-container">
    <form method="POST" class="order-form" enctype="multipart/form-data">
<div class="t1">
    <div>
        <div>
            {% if user and user.logo_data %}
                <img src="{{ url_for('get_user_logo', user_id=user.id) }}" width=168px height="83px" alt="Company Logo">
            {% else %}
                <img src="{{ url_for('static', filename='logo.png') }}" width=168px height="83px" alt="Company Logo">
            {% endif %}
        </div>
        <div class="t2"><div><b>PESANAN</b> No：TP</div><div style="border-bottom: 1px solid #666;"><input type="text" id="no" name="no" class="inps" value="{{ order.no or '' }}"></div></div></div>
    <div><table class="tb2">
        <tr><td>Name：</td><td class="vvc"><input type="text" id="nama" name="nama" class="inps" value="{{ order.nama or '' }}"></td><td></td><td class="nos">Terima Tgl：</td><td class="vvc"><input type="date" id="terima_tgl" name="terima_tgl" class="inps" value="{{ order.terima_tgl.strftime('%Y-%m-%d') if order.terima_tgl else '' }}"></td></tr>
        <tr><td>Telpon：</td><td class="vvc"><input type="text" id="telpon" name="telpon" class="inps" value="{{ order.telpon or '' }}"></td><td></td><td class="nos">Selesal Tgl：</td><td class="vvc"><input type="date" id="selesal_tgl" name="selesal_tgl" class="inps" value="{{ order.selesal_tgl.strftime('%Y-%m-%d') if order.selesal_tgl else '' }}"></td></tr>
        <tr><td>Alamat：</td><td colspan="4" class="vvc"><input type="text" name="alamat" class="inps" value="{{ order.alamat or '' }}"></td></tr>
        <tr><td colspan="5">
            {% if user and user.address %}
                {{ user.address|safe }}
                {% if user and user.tel %}Tel. {{ user.tel }}{% endif %}
                {% if user and user.fac %}Fac. {{ user.fac }}{% endif %}
            {% else %}
                Plaza TunjunganIVLt2Unit211-212JJendral Basuki Rachmad 2-12.Surabaya-Indonesia
                {% if user and user.tel %}Tel. {{ user.tel }}{% else %}Tel. +6231 5472647{% endif %}
                {% if user and user.fac %}Fac. {{ user.fac }}{% else %}Fac. +6231 5474057{% endif %}
            {% endif %}
        </td></tr>
        </table>
    </div>
</div>


<table class="tb3">
    <tr><td>KODE/GAMBAR</td><td colspan="2">BRAM/KARAT/INSTRUKSI</td></tr>
    <tr><td rowspan="10" width=280px >
        {% if order.image_url %}
        <div id="currentImageDiv">
            <img src="{{ order.image_url }}" alt="当前图片" onclick="replaceImage()" style="width: 280px;height: 200px" />
        </div>
        {% endif %}
        <div class="image-upload-area" id="uploadArea" {% if order.image_url %}style="display: none;"{% endif %}>
            <p class="upload-hint">Picture</p>
            <input type="file" id="image" name="image" accept="image/*"
                   style="display: none;" onchange="previewImage(this, 'preview')">
        </div>
        <div id="preview" class="image-preview" style="display: none;">
            <img src="" alt="预览" onclick="replaceImage()" style="width: 280px;height: 200px"  />
        </div>
        <input type="hidden" id="delete_image" name="delete_image" value="0">
    </td>
        <td colspan="2"><input type="text" name="bram_karat1" class="inps" value="{{ order.bram_karat1 or '' }}"></td></tr>
    <tr><td colspan="2"><input type="text" name="bram_karat2" class="inps" value="{{ order.bram_karat2 or '' }}"></td></tr>
    <tr><td colspan="2"><input type="text" name="bram_karat3" class="inps" value="{{ order.bram_karat3 or '' }}"></td></tr>
    <tr><td colspan="2"><input type="text" name="bram_karat4" class="inps" value="{{ order.bram_karat4 or '' }}"></td></tr>
    <tr><td colspan="2"><input type="text" name="bram_karat5" class="inps" value="{{ order.bram_karat5 or '' }}"></td></tr>
    <tr><td colspan="2"><input type="text" name="bram_karat6" class="inps" value="{{ order.bram_karat6 or '' }}"></td></tr>
    <tr><td colspan="2"><input type="text" name="bram_karat7" class="inps" value="{{ order.bram_karat7 or '' }}"></td></tr>
    <tr><td colspan="2"><input type="text" name="bram_karat8" class="inps" value="{{ order.bram_karat8 or '' }}"></td></tr>
    <tr><td colspan="2"><input type="text" name="bram_karat9" class="inps" value="{{ order.bram_karat9 or '' }}"></td></tr>
    <tr><td colspan="2"><input type="text" name="bram_karat10" class="inps" value="{{ order.bram_karat10 or '' }}"></td></tr>
    <tr><td colspan="3" style="border:none"></td></tr>
    <tr><td>TOKO</td><td>SPL/QC</td><td>PESANAN TIBA/ DIKIRIM TANGGAL</td></tr>
    <tr><td style="height: 50px"><textarea class="result1" name="toko">{{ order.toko or '' }}</textarea></td><td><textarea class="result1" name="spl_qc">{{ order.spl_qc or '' }}</textarea></td><td><input type="date" id="pesanan_tiba_dikirim_tanggal" name="pesanan_tiba_dikirim_tanggal" class="inps" value="{{ order.pesanan_tiba_dikirim_tanggal.strftime('%Y-%m-%d') if order.pesanan_tiba_dikirim_tanggal else '' }}"></td></tr>
</table>


        <div class="form-actions v-h">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="{{ url_for('order_list') }}" class="btn btn-secondary">Cancel</a><a onclick="javascript:window.print();" class="btn btn-secondary">Print</a>
        </div>
    </form>
</div>

<script>
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('image');
const deleteImageInput = document.getElementById('delete_image');
const currentImageDiv = document.getElementById('currentImageDiv');
const hasCurrentImage = {{ 'true' if order.image_url else 'false' }};

uploadArea.addEventListener('click', () => {
    fileInput.click();
});

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type.startsWith('image/')) {
        fileInput.files = files;
        previewImage(fileInput, 'preview');
    }
});

// 点击当前图片替换
function replaceImage() {
    fileInput.click();
}

function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.querySelector('img').src = e.target.result;
            preview.style.display = 'block';
            if (hasCurrentImage && currentImageDiv) {
                currentImageDiv.style.display = 'none';
            }
            uploadArea.style.display = 'none';
        }
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
        uploadArea.style.display = 'block';
        if (hasCurrentImage && currentImageDiv) {
            currentImageDiv.style.display = 'block';
        }
    }
}

function removeNewImage() {
    fileInput.value = '';
    document.getElementById('preview').style.display = 'none';
    if (hasCurrentImage && currentImageDiv) {
        currentImageDiv.style.display = 'block';
    }
    uploadArea.style.display = 'block';
}

function deleteCurrentImage() {
    if (confirm('Are you sure to delete the current image?')) {
        deleteImageInput.value = '1';
        if (currentImageDiv) {
            currentImageDiv.style.display = 'none';
        }
        uploadArea.style.display = 'block';
    }
}
</script>
{% endblock %}
