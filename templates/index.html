{% extends "base.html" %}

{% block content %}

<!-- Search Form -->
<div class="search-container">
    <form method="GET" action="{{ url_for('order_list') }}" class="search-form">
        <input type="text"
               name="search"
               placeholder="Search by order number, name, shop, code..."
               value="{{ request.args.get('search', '') }}"
               class="search-input">
        <select name="status" class="status-select" style="width: 150px;">
            <option value="">All Status</option>
            <option value="received" {% if request.args.get('status') == 'received' %}selected{% endif %}>Received</option>
            <option value="processing" {% if request.args.get('status') == 'processing' %}selected{% endif %}>Processing</option>
            <option value="paused" {% if request.args.get('status') == 'paused' %}selected{% endif %}>Paused</option>
            <option value="shipped" {% if request.args.get('status') == 'shipped' %}selected{% endif %}>Shipped</option>
            <option value="deleted" {% if request.args.get('status') == 'deleted' %}selected{% endif %}>Deleted</option>
        </select>
        <button type="submit" class="btn btn-primary search-btn">Search</button>
        {% if request.args.get('search') or request.args.get('status') %}
        <a href="{{ url_for('order_list') }}" class="btn btn-secondary">Clear</a>
        {% endif %}
    </form>
</div>

<div class="page-header v-h">
    <h1>Order List</h1>
    <a href="{{ url_for('order_add') }}" class="btn btn-primary">+ Add Order</a>
</div>



{% if orders %}
<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>Image</th>
                <th>No.</th>
                <th>Name/Tel</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td>{% if order.image_url %}<a href="{{ url_for('order_edit', order_id=order.id) }}" class="nav-link"><img src="{{ order.image_url }}" alt="Order Image" class="thumbnail" /></a>{% endif %}</td>
                <td>
                    <div class="order-id"><a href="{{ url_for('order_edit', order_id=order.id) }}" class="nav-link">{{ order.no or order.id }}</a></div>
                    {% if is_admin and order.owner_username %}<div class="text-small order-user">User: {{ order.owner_username }}</div>{% endif %}
                </td>
                <td><div class="date-info">{{ order.nama }}<br><div class="text-small order-user">{{ order.telpon }}</div></div></td>
                <td>
                    <div class="date-info">
                        <div>{{ order.created_at.strftime('%m-%d') }}</div>
                        {% if order.selesal_tgl %}
                        <div class="text-small">Done: {{ order.selesal_tgl.strftime('%m-%d') }}</div>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}" class="status-form">
                        <select name="status" class="status-select" onchange="this.form.submit()">
                            <option value="received" {% if order.status == 'received' or not order.status %}selected{% endif %}>Received</option>
                            <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
                            <option value="paused" {% if order.status == 'paused' %}selected{% endif %}>Paused</option>
                            <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Shipped</option>
                            <option value="deleted" {% if order.status == 'deleted' %}selected{% endif %}>Deleted</option>
                        </select>
                    </form>
                </td>
                <td>
                    <form method="POST" action="{{ url_for('order_delete', order_id=order.id) }}"
                          class="delete-form"
                          onsubmit="return confirm('Are you sure to delete this order?');">
                        <button type="submit" class="btn btn-sm btn-delete">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="pagination">
    <p class="pagination-info">Total {{ total }} records, Page {{ page }} / {{ total_pages }}</p>

    <div class="pagination-links">
        {% set search_param = request.args.get('search', '') %}
        {% set status_param = request.args.get('status', '') %}
        {% if page > 1 %}
        <a href="{{ url_for('order_list', page=1, search=search_param, status=status_param) }}" class="btn btn-sm">First</a>
        <a href="{{ url_for('order_list', page=page-1, search=search_param, status=status_param) }}" class="btn btn-sm">Prev</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <span class="btn btn-sm active">{{ p }}</span>
            {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="{{ url_for('order_list', page=p, search=search_param, status=status_param) }}" class="btn btn-sm">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <a href="{{ url_for('order_list', page=page+1, search=search_param, status=status_param) }}" class="btn btn-sm">Next</a>
        <a href="{{ url_for('order_list', page=total_pages, search=search_param, status=status_param) }}" class="btn btn-sm">Last</a>
        {% endif %}
    </div>
</div>
{% else %}
<div class="empty-state">
    <p>No orders found</p>
    <a href="{{ url_for('order_add') }}" class="btn btn-primary">Add First Order</a>
</div>
{% endif %}
{% endblock %}
